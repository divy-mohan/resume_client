{% extends "base.html" %}

{% block title %}Dashboard - Professional Writers{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<section class="py-4 bg-light">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="fade-in">Welcome back, {{ current_user.first_name }}!</h1>
                <p class="text-muted fade-in">Manage your orders and track your career documents</p>
            </div>
            <div class="col-lg-6 text-end">
                <a href="{{ url_for('services') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Order
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Dashboard Content -->
<section class="dashboard-section">
    <div class="container">
        <div class="row g-4">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="dashboard-sidebar fade-in">
                    <h5 class="mb-4"><i class="fas fa-user me-2"></i>My Account</h5>
                    
                    <ul class="nav nav-pills flex-column" id="dashboard-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="orders-tab" data-bs-toggle="pill" data-bs-target="#orders" type="button" role="tab">
                                <i class="fas fa-shopping-bag me-2"></i>My Orders
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="chat-tab" data-bs-toggle="pill" data-bs-target="#chat" type="button" role="tab">
                                <i class="fas fa-comments me-2"></i>Messages
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="profile-tab" data-bs-toggle="pill" data-bs-target="#profile" type="button" role="tab">
                                <i class="fas fa-user-edit me-2"></i>Profile
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="billing-tab" data-bs-toggle="pill" data-bs-target="#billing" type="button" role="tab">
                                <i class="fas fa-credit-card me-2"></i>Billing
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="dashboard-content fade-in">
                    <div class="tab-content" id="dashboard-tabContent">
                        <!-- Orders Tab -->
                        <div class="tab-pane fade show active" id="orders" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3>My Orders</h3>
                                <span class="text-muted">{{ orders|length }} total orders</span>
                            </div>
                            
                            {% if orders %}
                            <div class="orders-list">
                                {% for order in orders %}
                                <div class="order-card">
                                    <div class="row align-items-center">
                                        <div class="col-lg-8">
                                            <div class="order-info">
                                                <h5>{{ order.package.service.name }} - {{ order.package.name }}</h5>
                                                <p class="text-muted mb-2">Order #{{ order.order_number }}</p>
                                                <div class="order-meta">
                                                    <span class="me-3">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        {{ order.created_at.strftime('%B %d, %Y') }}
                                                    </span>
                                                    <span class="me-3">
                                                        <i class="fas fa-money-bill me-1"></i>
                                                        {{ order.currency }}{{ order.amount }}
                                                    </span>
                                                    <span class="order-status status-{{ order.status }}">
                                                        {{ order.status.replace('_', ' ').title() }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 text-end">
                                            <div class="order-actions">
                                                {% if order.status == 'pending' and order.payment_status == 'pending' %}
                                                <a href="{{ url_for('payment', order_id=order.id) }}" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-credit-card me-1"></i>Pay Now
                                                </a>
                                                {% elif order.status in ['confirmed', 'in_progress'] %}
                                                <button class="btn btn-info btn-sm" onclick="openChat({{ order.id }})">
                                                    <i class="fas fa-comments me-1"></i>Chat
                                                </button>
                                                {% endif %}
                                                <button class="btn btn-outline-secondary btn-sm ms-1" onclick="viewOrderDetails({{ order.id }})">
                                                    <i class="fas fa-eye me-1"></i>Details
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if order.notes %}
                                    <div class="order-notes mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-sticky-note me-1"></i>
                                            {{ order.notes }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="empty-state text-center py-5">
                                <i class="fas fa-shopping-bag text-muted" style="font-size: 4rem;"></i>
                                <h4 class="mt-3 text-muted">No Orders Yet</h4>
                                <p class="text-muted">Ready to get started? Choose a service and place your first order.</p>
                                <a href="{{ url_for('services') }}" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Browse Services
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Chat Tab -->
                        <div class="tab-pane fade" id="chat" role="tabpanel">
                            <h3 class="mb-4">Messages</h3>
                            
                            <div class="chat-interface">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="chat-list">
                                            <h5>Active Conversations</h5>
                                            {% for order in orders %}
                                            {% if order.status in ['confirmed', 'in_progress'] %}
                                            <div class="chat-item" onclick="loadChat({{ order.id }})">
                                                <div class="d-flex align-items-center">
                                                    <div class="chat-avatar me-3">
                                                        <i class="fas fa-user-tie"></i>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1">Order #{{ order.order_number }}</h6>
                                                        <small class="text-muted">{{ order.package.service.name }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="chat-container" class="chat-container" data-order-id="">
                                            <div class="chat-header">
                                                <i class="fas fa-comments me-2"></i>Select a conversation
                                            </div>
                                            <div id="chat-messages" class="chat-messages">
                                                <div class="text-center text-muted py-5">
                                                    <i class="fas fa-comments" style="font-size: 3rem;"></i>
                                                    <p class="mt-2">Select an active order to start chatting with our team</p>
                                                </div>
                                            </div>
                                            <div class="chat-input">
                                                <form id="chat-form">
                                                    <div class="input-group">
                                                        <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." disabled>
                                                        <button class="btn btn-primary" type="submit" disabled>
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                            <div id="typing-indicator" style="display: none;" class="px-3 py-2">
                                                <small class="text-muted">Support team is typing...</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Tab -->
                        <div class="tab-pane fade" id="profile" role="tabpanel">
                            <h3 class="mb-4">Profile Settings</h3>
                            
                            <div class="profile-form">
                                <form method="POST" action="{{ url_for('dashboard') }}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">First Name</label>
                                            <input type="text" class="form-control" name="first_name" value="{{ current_user.first_name }}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Last Name</label>
                                            <input type="text" class="form-control" name="last_name" value="{{ current_user.last_name }}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" name="email" value="{{ current_user.email }}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Phone</label>
                                            <input type="tel" class="form-control" name="phone" value="{{ current_user.phone or '' }}">
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Save Changes
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <hr class="my-5">
                            
                            <div class="password-section">
                                <h4>Change Password</h4>
                                <form method="POST" action="{{ url_for('dashboard') }}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" class="form-control" name="current_password" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">New Password</label>
                                            <input type="password" class="form-control" name="new_password" required>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-key me-2"></i>Update Password
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Billing Tab -->
                        <div class="tab-pane fade" id="billing" role="tabpanel">
                            <h3 class="mb-4">Billing & Payments</h3>
                            
                            <div class="billing-summary mb-4">
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <div class="stat-card text-center">
                                            <i class="fas fa-receipt text-primary" style="font-size: 2rem;"></i>
                                            <h4 class="mt-2">{{ orders|selectattr('payment_status', 'equalto', 'paid')|list|length }}</h4>
                                            <p class="text-muted">Paid Orders</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card text-center">
                                            <i class="fas fa-clock text-warning" style="font-size: 2rem;"></i>
                                            <h4 class="mt-2">{{ orders|selectattr('payment_status', 'equalto', 'pending')|list|length }}</h4>
                                            <p class="text-muted">Pending Payments</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card text-center">
                                            <i class="fas fa-rupee-sign text-success" style="font-size: 2rem;"></i>
                                            <h4 class="mt-2">₹{{ orders|selectattr('payment_status', 'equalto', 'paid')|sum(attribute='amount')|int }}</h4>
                                            <p class="text-muted">Total Spent</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-history">
                                <h4>Payment History</h4>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Order</th>
                                                <th>Service</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for order in orders %}
                                            <tr>
                                                <td>#{{ order.order_number }}</td>
                                                <td>{{ order.package.service.name }}</td>
                                                <td>{{ order.currency }}{{ order.amount }}</td>
                                                <td>
                                                    <span class="order-status status-{{ order.payment_status }}">
                                                        {{ order.payment_status.title() }}
                                                    </span>
                                                </td>
                                                <td>{{ order.created_at.strftime('%b %d, %Y') }}</td>
                                                <td>
                                                    {% if order.payment_status == 'pending' %}
                                                    <a href="{{ url_for('payment', order_id=order.id) }}" class="btn btn-sm btn-primary">Pay</a>
                                                    {% else %}
                                                    <button class="btn btn-sm btn-outline-secondary" onclick="downloadInvoice({{ order.id }})">Invoice</button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetailsContent">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_css %}
<style>
.order-card {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: var(--transition);
}

.order-card:hover {
    box-shadow: var(--shadow-soft);
}

.chat-list {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    height: 400px;
    overflow-y: auto;
}

.chat-item {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: var(--transition);
}

.chat-item:hover {
    background: var(--light-grey);
}

.chat-avatar {
    width: 40px;
    height: 40px;
    background: var(--gradient-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: var(--shadow-soft);
}

.empty-state {
    background: #f8f9fa;
    border-radius: 15px;
}
</style>
{% endblock %}

{% block additional_js %}
<script>
function viewOrderDetails(orderId) {
    // Load order details in modal
    document.getElementById('orderDetailsContent').innerHTML = `
        <div class="text-center py-4">
            <div class="loading-spinner"></div>
            <p class="mt-2">Loading order details...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    modal.show();
    
    // In a real application, this would fetch order details via AJAX
    setTimeout(() => {
        document.getElementById('orderDetailsContent').innerHTML = `
            <div class="order-detail">
                <h5>Order #ORD-${orderId}</h5>
                <p>Order details would be displayed here with files, status updates, and communication history.</p>
            </div>
        `;
    }, 1000);
}

function openChat(orderId) {
    // Switch to chat tab and load conversation
    const chatTab = document.getElementById('chat-tab');
    chatTab.click();
    
    setTimeout(() => {
        loadChat(orderId);
    }, 100);
}

function loadChat(orderId) {
    const chatContainer = document.getElementById('chat-container');
    const chatInput = document.getElementById('chat-input');
    const chatSubmit = chatContainer.querySelector('button[type="submit"]');
    
    // Enable chat interface
    chatContainer.dataset.orderId = orderId;
    chatInput.disabled = false;
    chatSubmit.disabled = false;
    
    // Update header
    const chatHeader = chatContainer.querySelector('.chat-header');
    chatHeader.innerHTML = `<i class="fas fa-comments me-2"></i>Order #ORD-${orderId}`;
    
    // Load chat history
    if (window.chatSystem) {
        window.chatSystem.openChat(orderId);
    }
}

function downloadInvoice(orderId) {
    // In a real application, this would download the invoice
    alert(`Downloading invoice for order ${orderId}`);
}
</script>
{% endblock %}
